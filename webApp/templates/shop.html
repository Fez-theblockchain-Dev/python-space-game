{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="checkout-section">
    <div class="container">
        <div class="checkout-header">
            <h1>Checkout</h1>
            <p>Review your order and complete your purchase</p>
        </div>

        <div class="checkout-layout">
            <!-- Cart Items Column -->
            <div class="cart-column">
                <div class="card cart-card">
                    <div class="cart-header">
                        <h2>
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            Your Cart
                        </h2>
                        <button id="clear-cart-btn" class="btn-text" title="Clear cart">Clear All</button>
                    </div>

                    <!-- Empty Cart State -->
                    <div id="empty-cart" class="empty-cart">
                        <div class="empty-cart-icon">ðŸ›’</div>
                        <h3>Your cart is empty</h3>
                        <p>Add some power-ups to get started!</p>
                        <a href="/" class="btn btn-secondary">Browse Packages</a>
                    </div>

                    <!-- Cart Items List -->
                    <div id="cart-items" class="cart-items"></div>

                    <!-- Add More Items -->
                    <div id="add-more-section" class="add-more-section" style="display: none;">
                        <div class="add-more-header">
                            <span>Add More Items</span>
                        </div>
                        <div class="quick-add-grid">
                            {% for package in packages %}
                            <button class="quick-add-btn" data-package-id="{{ package.id }}" data-name="{{ package.name }}" data-price="{{ package.price }}" data-gold="{{ package.gold_coins }}" data-health="{{ package.health_packs }}">
                                <span class="quick-add-icon">
                                    {% if package.gold_coins > 0 and package.health_packs > 0 %}âœ¨
                                    {% elif package.gold_coins > 0 %}ðŸª™
                                    {% else %}ðŸ’š{% endif %}
                                </span>
                                <span class="quick-add-name">{{ package.name }}</span>
                                <span class="quick-add-price">${{ package.price }}</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary Column -->
            <div class="summary-column">
                <div class="card summary-card">
                    <h2>Order Summary</h2>

                    <div class="summary-lines">
                        <div class="summary-line">
                            <span>Subtotal</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="summary-line">
                            <span>Estimated Tax <span class="tax-rate">(8.25%)</span></span>
                            <span id="tax-amount">$0.00</span>
                        </div>
                        <div class="summary-line discount-line" id="discount-line" style="display: none;">
                            <span>Discount</span>
                            <span id="discount-amount" class="discount-value">-$0.00</span>
                        </div>
                    </div>

                    <div class="summary-total">
                        <span>Total</span>
                        <span id="total-amount">$0.00</span>
                    </div>

                    <!-- Promo Code -->
                    <div class="promo-section">
                        <div class="promo-input-group">
                            <input type="text" id="promo-code" placeholder="Promo code" class="promo-input">
                            <button id="apply-promo" class="btn btn-secondary btn-sm">Apply</button>
                        </div>
                        <div id="promo-message" class="promo-message"></div>
                    </div>

                    <!-- Checkout Button -->
                    <button id="checkout-btn" class="btn btn-primary btn-checkout" disabled>
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                        Proceed to Payment
                    </button>

                    <div id="checkout-error" class="checkout-error"></div>

                    <!-- Payment Methods -->
                    <div class="payment-methods-info">
                        <p>Secure checkout powered by</p>
                        <div class="payment-badges">
                            <span class="payment-badge">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
                                Apple Pay
                            </span>
                            <span class="payment-badge">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/></svg>
                                Google Pay
                            </span>
                            <span class="payment-badge">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                                Card
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Security Badges -->
                <div class="security-info">
                    <div class="security-badge">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                        <span>SSL Secured</span>
                    </div>
                    <div class="security-badge">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                        <span>Encrypted</span>
                    </div>
                    <div class="security-badge">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        <span>Verified</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// ============================================================================
// Space Cowboys Game Shop - Guest Checkout Portal
// ============================================================================

window.__SPACEGAME_STRIPE_PUBLISHABLE_KEY__ = "{{ stripe_publishable_key|escapejs }}";
window.__SPACEGAME_PLAYER_UUID__ = "{{ player_uuid|default:''|escapejs }}";

window.__SPACEGAME_API__ = {
    createCheckoutSession: "/api/create-checkout-session/",
    createPaymentIntent: "/api/create-payment-intent/"
};

// Package data from server
const PACKAGES = {
    {% for package in packages %}
    "{{ package.id }}": {
        id: "{{ package.id }}",
        name: "{{ package.name|escapejs }}",,
        price: {{ package.price }},
        gold_coins: {{ package.gold_coins }},
        health_packs: {{ package.health_packs }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

// tax for store checkout will be handeled in the views.py file now through the stripe API

// Cart storage key
const CART_STORAGE_KEY = "spacegame_cart";

// ============================================================================
// Cart State Management
// ============================================================================

function getCart() {
    try {
        const stored = localStorage.getItem(CART_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch (e) {
        return [];
    }
}

function saveCart(cart) {
    localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
}

function addToCart(packageId, quantity = 1) {
    const cart = getCart();
    const existingIndex = cart.findIndex(item => item.id === packageId);
    
    if (existingIndex >= 0) {
        cart[existingIndex].quantity = Math.min(99, cart[existingIndex].quantity + quantity);
    } else {
        cart.push({ id: packageId, quantity: quantity });
    }
    
    saveCart(cart);
    renderCart();
}

function updateQuantity(packageId, quantity) {
    const cart = getCart();
    const item = cart.find(item => item.id === packageId);
    
    if (item) {
        item.quantity = Math.max(1, Math.min(99, quantity));
        saveCart(cart);
        renderCart();
    }
}

function removeFromCart(packageId) {
    let cart = getCart();
    cart = cart.filter(item => item.id !== packageId);
    saveCart(cart);
    renderCart();
}

function clearCart() {
    saveCart([]);
    renderCart();
}

// ============================================================================
// Calculate Totals
// ============================================================================

function calculateTotals() {
    const cart = getCart();
    let subtotal = 0;
    
    cart.forEach(item => {
        const pkg = PACKAGES[item.id];
        if (pkg) {
            subtotal += pkg.price * item.quantity;
        }
    });
    
    const tax = subtotal * TAX_RATE;
    const total = subtotal + tax;
    
    return {
        subtotal: subtotal,
        tax: tax,
        total: total,
        itemCount: cart.reduce((sum, item) => sum + item.quantity, 0)
    };
}

// ============================================================================
// Render Cart UI
// ============================================================================

function renderCart() {
    const cart = getCart();
    const cartItemsEl = document.getElementById("cart-items");
    const emptyCartEl = document.getElementById("empty-cart");
    const addMoreEl = document.getElementById("add-more-section");
    const checkoutBtn = document.getElementById("checkout-btn");
    
    // Show/hide empty state
    const isEmpty = cart.length === 0;
    emptyCartEl.style.display = isEmpty ? "block" : "none";
    cartItemsEl.style.display = isEmpty ? "none" : "flex";
    addMoreEl.style.display = isEmpty ? "none" : "block";
    checkoutBtn.disabled = isEmpty;
    
    // Render cart items
    if (!isEmpty) {
        cartItemsEl.innerHTML = cart.map(item => {
            const pkg = PACKAGES[item.id];
            if (!pkg) return "";
            
            const iconType = pkg.gold_coins > 0 && pkg.health_packs > 0 ? "bundle" : 
                            pkg.gold_coins > 0 ? "gold" : "health";
            const emoji = iconType === "bundle" ? "âœ¨" : iconType === "gold" ? "ðŸª™" : "ðŸ’š";
            const lineTotal = (pkg.price * item.quantity).toFixed(2);
            
            return `
                <div class="cart-item" data-id="${item.id}">
                    <div class="cart-item-icon ${iconType}">${emoji}</div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${pkg.name}</div>
                        <div class="cart-item-rewards">
                            ${pkg.gold_coins > 0 ? `<span class="gold">ðŸª™ ${pkg.gold_coins}</span>` : ""}
                            ${pkg.health_packs > 0 ? `<span class="health">ðŸ’š ${pkg.health_packs}</span>` : ""}
                        </div>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="qty-btn" data-action="decrease" ${item.quantity <= 1 ? "disabled" : ""}>âˆ’</button>
                        <span class="qty-value">${item.quantity}</span>
                        <button class="qty-btn" data-action="increase" ${item.quantity >= 99 ? "disabled" : ""}>+</button>
                    </div>
                    <div class="cart-item-price">$${lineTotal}</div>
                    <button class="cart-item-remove" title="Remove item">
                        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                </div>
            `;
        }).join("");
    }
    
    // Update totals
    updateTotals();
}

function updateTotals() {
    const totals = calculateTotals();
    
    document.getElementById("subtotal").textContent = `$${totals.subtotal.toFixed(2)}`;
    document.getElementById("tax-amount").textContent = `$${totals.tax.toFixed(2)}`;
    document.getElementById("total-amount").textContent = `$${totals.total.toFixed(2)}`;
}

// ============================================================================
// Event Handlers
// ============================================================================

function setupEventListeners() {
    // Cart item quantity and remove
    document.getElementById("cart-items").addEventListener("click", function(e) {
        const cartItem = e.target.closest(".cart-item");
        if (!cartItem) return;
        
        const packageId = cartItem.dataset.id;
        const cart = getCart();
        const item = cart.find(i => i.id === packageId);
        if (!item) return;
        
        // Quantity buttons
        if (e.target.closest(".qty-btn")) {
            const action = e.target.closest(".qty-btn").dataset.action;
            if (action === "increase") {
                updateQuantity(packageId, item.quantity + 1);
            } else if (action === "decrease") {
                updateQuantity(packageId, item.quantity - 1);
            }
        }
        
        // Remove button
        if (e.target.closest(".cart-item-remove")) {
            removeFromCart(packageId);
        }
    });
    
    // Quick add buttons
    document.querySelectorAll(".quick-add-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const packageId = this.dataset.packageId;
            addToCart(packageId, 1);
        });
    });
    
    // Clear cart
    document.getElementById("clear-cart-btn").addEventListener("click", function() {
        if (confirm("Are you sure you want to clear your cart?")) {
            clearCart();
        }
    });
    
    // Promo code (demo functionality)
    document.getElementById("apply-promo").addEventListener("click", function() {
        const promoInput = document.getElementById("promo-code");
        const promoMessage = document.getElementById("promo-message");
        const code = promoInput.value.trim().toUpperCase();
        
        promoMessage.className = "promo-message";
        
        if (!code) {
            promoMessage.textContent = "Please enter a promo code";
            promoMessage.classList.add("error");
            return;
        }
        
        // Demo: Accept "SPACE10" for 10% off
        if (code === "SPACE10") {
            promoMessage.textContent = "Promo code applied! 10% discount at checkout.";
            promoMessage.classList.add("success");
            // Note: Actual discount would be applied server-side via Stripe coupons
        } else {
            promoMessage.textContent = "Invalid promo code";
            promoMessage.classList.add("error");
        }
    });
    
    // Checkout button
    document.getElementById("checkout-btn").addEventListener("click", async function() {
        const cart = getCart();
        if (cart.length === 0) return;
        
        const btn = this;
        const errorEl = document.getElementById("checkout-error");
        
        // Disable button
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner"></span> Processing...';
        errorEl.classList.remove("show");
        
        try {
            // Build items array for API
            const items = cart.map(item => ({
                id: item.id,
                quantity: item.quantity
            }));
            
            const payload = { items: items };
            
            if (window.__SPACEGAME_PLAYER_UUID__) {
                payload.player_uuid = window.__SPACEGAME_PLAYER_UUID__;
            }
            
            const response = await fetch(window.__SPACEGAME_API__.createCheckoutSession, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || "Failed to create checkout session");
            }
            
            if (data.url) {
                // Clear cart before redirect (will be handled by Stripe success page)
                // Don't clear here - clear on success callback instead
                window.location.href = data.url;
            } else {
                throw new Error("No checkout URL returned");
            }
        } catch (err) {
            errorEl.textContent = err.message || "Something went wrong. Please try again.";
            errorEl.classList.add("show");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
}

// ============================================================================
// Initialize
// ============================================================================

document.addEventListener("DOMContentLoaded", function() {
    renderCart();
    setupEventListeners();
    
    // Check for success redirect (clear cart)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("success") === "true") {
        clearCart();
    }
});
</script>
{% endblock %}
